<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>H·ªì s∆° c√° nh√¢n - Forum</title>
  <link rel="icon" sizes="192x192" href="/favicon-192.png">
  <link rel="stylesheet" href="./style.css" />
</head>
<body>

  <nav class="navbar">
    <div class="nav-left">
      <a href="home.html" class="nav-brand">Forum</a>
    </div>
    <div class="nav-right">
    </div>
  </nav>

  <main class="profile-container">
    <h2>H·ªì s∆° c√° nh√¢n</h2>

    <div id="profile-view">
      <div class="avatar-wrapper">
        <img id="view-avatar" src="https://via.placeholder.com/150" alt="Avatar" class="profile-avatar">
      </div>
      <div class="profile-meta" style="text-align:center; margin-bottom: 16px;">
        <h3 id="view-username">T√™n ng∆∞·ªùi d√πng</h3>
        <p id="view-bio" style="color:var(--text-light); margin-top:8px; max-width:640px; margin-left:auto; margin-right:auto; white-space:pre-wrap;"></p>
        <p id="view-uuid" style="color:var(--text-light)"></p>
        <p id="view-contact" style="color:var(--text-light)"></p>
        <div class="profile-actions" style="justify-content:center; margin-top:12px;">
          <button id="edit-profile-btn" class="btn-primary hidden">Edit profile</button>
        </div>
      </div>
    </div>

    <!-- Edit popup -->
    <div id="edit-popup" class="popup" style="display:none;">
      <div class="popup-content">
        <button id="close-edit" class="btn-secondary" style="float:right;">ƒê√≥ng</button>
        <h3 style="margin-top:0;">Ch·ªânh s·ª≠a h·ªì s∆°</h3>

        <form id="profile-form">
          <div class="avatar-wrapper">
            <img id="avatar-preview" src="https://via.placeholder.com/150" alt="Avatar" class="profile-avatar">
            <label for="avatar-input" class="upload-label" title="ƒê·ªïi ·∫£nh ƒë·∫°i di·ªán">üì∑</label>
            <input type="file" id="avatar-input" accept="image/*">
          </div>

          <div class="form-group">
            <label>Email (Kh√¥ng th·ªÉ ƒë·ªïi)</label>
            <input type="text" id="email" readonly placeholder="ƒêang t·∫£i...">
          </div>

          <div class="form-group">
            <label>T√™n hi·ªÉn th·ªã</label>
            <input type="text" id="username" placeholder="Nh·∫≠p t√™n m·ªõi" required>
          </div>
          <p id="username-cooldown" style="font-size: 0.9em; margin-top: 5px; color: orange;"></p>

          <div id="uuid-section" class="form-group" style="margin-top:8px;">
            <label>M√£ ƒë·ªãnh danh (UUID)</label>
            <div style="display:flex; gap:8px; align-items:center;">
              <input type="text" id="uuid-display" style="flex:1; padding:10px; border-radius:8px; border:1px solid var(--border-color); background:var(--input-bg);">
            </div>
            <p id="uuid-cooldown" style="font-size:0.9em; margin-top:6px; color:var(--text-light);"></p>
          </div>

          <div class="form-group">
            <label>Ti·ªÉu s·ª≠ (Bio)</label>
            <textarea id="bio" placeholder="Vi·∫øt v√†i d√≤ng v·ªÅ b·∫°n..." style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border-color); background:var(--input-bg); min-height:80px;"></textarea>
          </div>
        </form>

        <!-- ƒê·ªïi m·∫≠t kh·∫©u -->
        <div class="password-section" style="margin-top:18px; border-top:1px solid var(--border-color); padding-top:12px;">
          <h4 style="margin:8px 0 12px;">ƒê·ªïi m·∫≠t kh·∫©u</h4>
          <div class="form-group">
            <label>M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
            <input type="password" id="current-password" placeholder="Nh·∫≠p m·∫≠t kh·∫©u c≈©">
          </div>
          <div class="form-group">
            <label>M·∫≠t kh·∫©u m·ªõi</label>
            <input type="password" id="new-password" placeholder="M·∫≠t kh·∫©u m·ªõi">
          </div>
          <div class="form-group">
            <label>Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi</label>
            <input type="password" id="confirm-password" placeholder="X√°c nh·∫≠n m·∫≠t kh·∫©u">
          </div>
        </div>

        <!-- N√∫t h√†nh ƒë·ªông th·∫≥ng h√†ng -->
        <div style="display:flex; gap:12px; justify-content:flex-end; margin-top:20px;">
          <button type="button" id="save-btn" class="btn-primary">L∆∞u thay ƒë·ªïi</button>
          <button type="button" id="change-pwd-btn" class="btn-secondary">C·∫≠p nh·∫≠t m·∫≠t kh·∫©u</button>
        </div>

        <p id="msg" style="margin-top:12px; text-align:center;"></p>
        <p id="pwd-msg" style="margin-top:8px; text-align:center; font-size:0.95rem;"></p>
      </div>
    </div>
  </main>

  <script src="/theme.js"></script>
  <script>
    // ================ H√ÄM T·∫¢I PROFILE ================
    async function loadProfile() {
      const pathMatch = location.pathname.match(/@([a-zA-Z0-9\-_:]+)/);
      const targetUuid = pathMatch ? pathMatch[1] : null;

      console.log("ƒêang t·∫£i profile cho UUID:", targetUuid || "(profile ch√≠nh m√¨nh)");

      let target = null;

      try {
        if (targetUuid) {
          const response = await fetch(`/users/${encodeURIComponent(targetUuid)}`, { credentials: 'include' });
          if (response.ok) {
            const data = await response.json();
            target = data.user;
          } else if (response.status === 404) {
            document.getElementById('profile-view').innerHTML = 
              '<p style="text-align:center; color:red; margin:40px 0;">Ng∆∞·ªùi d√πng kh√¥ng t·ªìn t·∫°i.</p>';
            return;
          } else {
            document.getElementById('profile-view').innerHTML = 
              `<p style="text-align:center; color:red; margin:40px 0;">L·ªói t·∫£i d·ªØ li·ªáu: ${response.status}</p>`;
            return;
          }
        } else {
          const response = await fetch('/auth/me', { credentials: 'include' });
          if (response.ok) {
            const data = await response.json();
            target = data.user || data;
          } else if (response.status === 401) {
            document.getElementById('profile-view').innerHTML = 
              '<p style="text-align:center; color:red; margin:40px 0;">Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem h·ªì s∆° c√° nh√¢n.</p>';
            return;
          } else {
            document.getElementById('profile-view').innerHTML = 
              `<p style="text-align:center; color:red; margin:40px 0;">L·ªói t·∫£i d·ªØ li·ªáu: ${response.status}</p>`;
            return;
          }
        }
      } catch (err) {
        console.error('Load profile error:', err);
        document.getElementById('profile-view').innerHTML = 
          '<p style="text-align:center; color:red; margin:40px 0;">L·ªói k·∫øt n·ªëi server. Vui l√≤ng th·ª≠ l·∫°i.</p>';
        return;
      }

      if (!target || !target.uuid) {
        document.getElementById('profile-view').innerHTML = 
          '<p style="text-align:center; color:red; margin:40px 0;">Kh√¥ng t√¨m th·∫•y th√¥ng tin ng∆∞·ªùi d√πng.</p>';
        return;
      }

      window.__targetUser = target;
      window.__targetUserId = target._id || target.id;

      document.getElementById('view-username').textContent = target.username || 'T√™n ng∆∞·ªùi d√πng';
      document.getElementById('view-bio').textContent = target.bio || '';
      document.getElementById('view-uuid').textContent = `UUID: ${target.uuid}`;

      const avatarImg = document.getElementById('view-avatar');
      avatarImg.src = target.avatar && target.avatar.trim() ? target.avatar : 'https://via.placeholder.com/150';

      // Hi·ªÉn th·ªã n√∫t Edit
      const editBtn = document.getElementById('edit-profile-btn');
      if (editBtn) {
        let isOwner = !targetUuid;
        let isAdmin = false;
        try {
          const meRes = await fetch('/auth/me', { credentials: 'include' });
          if (meRes.ok) {
            const meData = await meRes.json();
            const currentUser = meData.user || meData;
            window.__currentUser = currentUser;
            isOwner = isOwner || currentUser.uuid === target.uuid;
            isAdmin = currentUser.role === 'admin';
          }
        } catch (e) {}
        if (isOwner || isAdmin) {
          editBtn.classList.remove('hidden');
        } else {
          editBtn.classList.add('hidden');
        }
      }
if (!target) return;

    // --- LOGIC HI·ªÇN TH·ªä COOLDOWN M·ªöI ---
    
    // 1. Cooldown cho Username (7 ng√†y)
    const userLastChanged = target.usernameLastChangedAt || target.createdAt;
    const userDaysLeft = getCooldownDays(userLastChanged, 7);
    const usernameCooldownEl = document.getElementById('username-cooldown');
    
    if (userDaysLeft > 0) {
        usernameCooldownEl.textContent = `‚è≥ B·∫°n c√≥ th·ªÉ ƒë·ªïi t√™n sau ${userDaysLeft} ng√†y n·ªØa.`;
        usernameCooldownEl.style.color = "orange";
    } else {
        usernameCooldownEl.textContent = `‚úÖ B·∫°n c√≥ th·ªÉ ƒë·ªïi t√™n ngay b√¢y gi·ªù.`;
        usernameCooldownEl.style.color = "green";
    }

    // 2. Cooldown cho UUID (30 ng√†y)
    const uuidLastChanged = target.uuidLastChangedAt || target.createdAt;
    const uuidDaysLeft = getCooldownDays(uuidLastChanged, 30);
    const uuidCooldownEl = document.getElementById('uuid-cooldown');
    
    if (uuidDaysLeft > 0) {
        uuidCooldownEl.textContent = `‚è≥ B·∫°n c√≥ th·ªÉ ƒë·ªïi UUID sau ${uuidDaysLeft} ng√†y n·ªØa.`;
        uuidCooldownEl.style.color = "orange";
    } else {
        uuidCooldownEl.textContent = `‚úÖ B·∫°n c√≥ th·ªÉ ƒë·ªïi UUID ngay b√¢y gi·ªù.`;
        uuidCooldownEl.style.color = "green";
    }
      // C·∫≠p nh·∫≠t form edit
      document.getElementById('username').value = target.username || '';
      document.getElementById('bio').value = target.bio || '';
      document.getElementById('uuid-display').value = target.uuid || '';
      document.getElementById('avatar-preview').src = target.avatar && target.avatar.trim() ? target.avatar : 'https://via.placeholder.com/150';
    }

    // ================ C√ÅC H√ÄM KH√ÅC (EDIT, SAVE, CHANGE PASSWORD) ================
function getCooldownDays(lastChangedDate, cooldownPeriodDays) {
    const lastChanged = new Date(lastChangedDate).getTime();
    const now = Date.now();
    const cooldownMs = cooldownPeriodDays * 24 * 60 * 60 * 1000;
    const timePassed = now - lastChanged;

    if (timePassed >= cooldownMs) return 0; // H·∫øt th·ªùi gian ch·ªù

    const remainingMs = cooldownMs - timePassed;
    return Math.ceil(remainingMs / (24 * 60 * 60 * 1000)); // L√†m tr√≤n l√™n s·ªë ng√†y
}
    const bioEl = document.getElementById('bio');
    const avatarInput = document.getElementById('avatar-input');

    // Avatar preview
    if (avatarInput) {
      avatarInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (ev) => {
            document.getElementById('avatar-preview').src = ev.target.result;
          };
          reader.readAsDataURL(file);
        }
      });
    }

    // M·ªü/ƒë√≥ng popup
    const editBtn = document.getElementById('edit-profile-btn');
    const editPopup = document.getElementById('edit-popup');
    const closeEdit = document.getElementById('close-edit');

    if (editBtn) editBtn.onclick = () => { editPopup.style.display = 'flex'; };
    if (closeEdit) closeEdit.onclick = () => { editPopup.style.display = 'none'; };
    if (editPopup) editPopup.addEventListener('click', (e) => {
      if (e.target === editPopup) editPopup.style.display = 'none';
    });

    // L∆∞u thay ƒë·ªïi
    const saveBtn = document.getElementById('save-btn');
    const msg = document.getElementById('msg');

    if (saveBtn) {
 saveBtn.onclick = async () => {
    msg.textContent = "ƒêang l∆∞u...";
    msg.style.color = "blue";
    saveBtn.disabled = true;

    const usernameInput = document.getElementById("username");
    const bioInput = document.getElementById("bio");
    const targetUser = window.__targetUser;
    const uuidInput = document.getElementById("uuid-display");
    const requestedUuid = uuidInput.value.trim();

    const formData = new FormData();
    formData.append("username", usernameInput.value.trim());
    formData.append("bio", bioInput.value.trim());
    formData.append("uuid", requestedUuid); // G·ª≠i gi√° tr·ªã UUID m·ªõi
    formData.append("changeUuid", "1");      // G·ª≠i flag x√°c nh·∫≠n mu·ªën ƒë·ªïi UUID

    if (avatarInput.files[0]) {
        formData.append("avatar", avatarInput.files[0]);
    }

    try {
    const res = await fetch("/auth/me", {
        method: 'PUT',
        credentials: 'include',
        body: formData
    });

    const data = await res.json(); // Backend tr·∫£ v·ªÅ { message, user: { uuid, ... } }

    if (res.ok) {
        msg.style.color = "green";
        msg.textContent = "‚úÖ C·∫≠p nh·∫≠t th√†nh c√¥ng!";

        const newUuid = data.user.uuid;
        const currentPath = window.location.pathname;

        setTimeout(() => {
            // Ki·ªÉm tra n·∫øu URL hi·ªán t·∫°i c√≥ ch·ª©a @ (ƒë·ªãnh d·∫°ng profile c·ªßa b·∫°n)
            if (currentPath.includes('@')) {
                const oldUuidMatch = currentPath.match(/@([a-zA-Z0-9\-_]+)/);
                const oldUuid = oldUuidMatch ? oldUuidMatch[1] : null;

                // N·∫øu UUID m·ªõi kh√°c UUID c≈© trong URL, ti·∫øn h√†nh chuy·ªÉn h∆∞·ªõng
                if (oldUuid && oldUuid !== newUuid) {
                    window.location.href = currentPath.replace(`@${oldUuid}`, `@${newUuid}`);
                    return;
                }
            }
            
            // N·∫øu kh√¥ng thu·ªôc tr∆∞·ªùng h·ª£p tr√™n ho·∫∑c kh√¥ng ƒë·ªïi UUID, ch·ªâ c·∫ßn t·∫£i l·∫°i trang
            location.reload();
        }, 1000);
    } else {
        msg.style.color = "red";
        msg.textContent = "‚ùå " + (data.error || "C√≥ l·ªói x·∫£y ra");
    }
} catch (err) {
    msg.textContent = "‚ùå L·ªói k·∫øt n·ªëi server.";
}
    // L·∫•y th√¥ng tin ng∆∞·ªùi ƒëang xem (viewer) m·ªôt c√°ch ch√≠nh x√°c
    let viewer = null;
    try {
        const r = await fetch('/auth/me', { credentials: 'include' });
        if (r.ok) {
            const data = await r.json();
            // C·∫•u tr√∫c /auth/me tr·∫£ v·ªÅ tr·ª±c ti·∫øp user object, kh√¥ng c√≥ .user
            viewer = data; 
        }
    } catch (e) { console.error("L·ªói l·∫•y th√¥ng tin viewer:", e); }

    if (!viewer) {
        msg.style.color = 'red';
        msg.textContent = 'Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.';
        saveBtn.disabled = false;
        return;
    }

    // Ki·ªÉm tra quy·ªÅn: L√† ch·ªß s·ªü h·ªØu HO·∫∂C l√† admin
    const isOwner = viewer.uuid === targetUser.uuid;
    const isAdmin = viewer.role === 'admin';

    if (isOwner) {
        // G·ª≠i qua /auth/me (Cho ch√≠nh m√¨nh)
const uuidInput = document.getElementById("uuid-display");
    const requestedUuid = uuidInput.value.trim();

    // 2. Ki·ªÉm tra n·∫øu tr·ªëng th√¨ b√°o l·ªói ngay t·∫°i tr√¨nh duy·ªát
    if (!requestedUuid) {
        msg.style.color = 'red';
        msg.textContent = '‚ùå B·∫°n ch∆∞a nh·∫≠p m√£ ƒë·ªãnh danh (UUID) m·ªõi!';
        uuidInput.focus(); // Nh·∫£y con tr·ªè v√†o √¥ ƒë·ªÉ nh·∫Øc ng∆∞·ªùi d√πng
        return;
    }

    const formData = new FormData();
    formData.append("username", document.getElementById("username").value.trim());
    formData.append("bio", document.getElementById("bio").value.trim());
    
    // 3. QUAN TR·ªåNG: ƒê∆∞a gi√° tr·ªã ƒë√£ nh·∫≠p v√†o FormData
    formData.append("uuid", requestedUuid); 
    
    // ƒê√°nh d·∫•u cho server bi·∫øt l√† c√≥ y√™u c·∫ßu ƒë·ªïi UUID
    formData.append("changeUuid", "1");

    if (avatarInput.files[0]) formData.append("avatar", avatarInput.files[0]);

        // Logic ƒë·ªïi UUID (gi·ªØ nguy√™n)
        const lastUuidChanged = new Date(targetUser.uuidLastChangedAt || targetUser.createdAt).getTime();
        if (Date.now() - lastUuidChanged >= 30 * 24 * 60 * 60 * 1000) {
            formData.append('changeUuid', '1');
        }

        // T√¨m ƒëo·∫°n n√†y trong profile.html v√† s·ª≠a l·∫°i:
try {
    const res = await fetch("/auth/me", { method: 'PUT', credentials: 'include', body: formData });
    
    // CH·ªà G·ªåI D√íNG N√ÄY M·ªòT L·∫¶N DUY NH·∫§T
    const data = await res.json(); 

    if (res.ok) {
        msg.style.color = "green";
        msg.textContent = "‚úÖ C·∫≠p nh·∫≠t th√†nh c√¥ng!";

        const newUuid = data.user?.uuid;
        const currentPath = window.location.pathname;

        // Logic chuy·ªÉn h∆∞·ªõng n·∫øu ƒë·ªïi UUID th√†nh c√¥ng
        if (currentPath.includes('@') && newUuid) {
            const oldUuidMatch = currentPath.match(/@([a-zA-Z0-9\-_:]+)/);
            if (oldUuidMatch && oldUuidMatch[1] !== newUuid) {
                alert("UUID c·ªßa b·∫°n ƒë√£ thay ƒë·ªïi. Trang s·∫Ω t·ª± ƒë·ªông chuy·ªÉn h∆∞·ªõng.");
                window.location.href = currentPath.replace(`@${oldUuidMatch[1]}`, `@${newUuid}`);
                return;
            }
        }
        
        setTimeout(() => {
            editPopup.style.display = 'none';
            loadProfile();
        }, 1000);
    } else {
        // Hi·ªÉn th·ªã l·ªói t·ª´ backend (v√≠ d·ª•: Cooldown ch∆∞a h·∫øt)
        msg.style.color = 'red';
        msg.textContent = '‚ùå ' + (data.error || 'C√≥ l·ªói x·∫£y ra');
    }
} catch (err) {
    console.error(err); // Xem l·ªói chi ti·∫øt t·∫°i Console log
    msg.style.color = 'red';
    msg.textContent = 'L·ªói k·∫øt n·ªëi server ho·∫∑c l·ªói x·ª≠ l√Ω d·ªØ li·ªáu.';
}
    } else if (isAdmin) {
        // G·ª≠i qua /users/:uuid (Admin s·ª≠a cho ng∆∞·ªùi kh√°c)
        const body = { 
            username: usernameInput.value.trim(),
            bio: bioInput.value.trim()
        };

        try {
            const res = await fetch(`/users/${encodeURIComponent(targetUser.uuid)}`, {
                method: 'PUT',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            if (res.ok) {
                msg.style.color = "green";
                msg.textContent = "‚úÖ Admin ƒë√£ c·∫≠p nh·∫≠t th√†nh c√¥ng!";
                setTimeout(() => location.reload(), 1000);
            } else {
                const data = await res.json();
                msg.style.color = 'red';
                msg.textContent = '‚ùå ' + (data.error || 'L·ªói Admin');
            }
        } catch (err) {
            msg.textContent = 'L·ªói k·∫øt n·ªëi server.';
        }
    } else {
        msg.style.color = 'red';
        msg.textContent = 'B·∫°n kh√¥ng c√≥ quy·ªÅn thay ƒë·ªïi th√¥ng tin n√†y.';
    }
    saveBtn.disabled = false;
    };
    }

    // ƒê·ªïi m·∫≠t kh·∫©u
    const changePwdBtn = document.getElementById("change-pwd-btn");
    const pwdMsg = document.getElementById("pwd-msg");
    if (changePwdBtn) {
      changePwdBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        pwdMsg.textContent = '';
        const currentPassword = document.getElementById("current-password").value;
        const newPassword = document.getElementById("new-password").value;
        const confirmPassword = document.getElementById("confirm-password").value;

        if (newPassword !== confirmPassword) {
          pwdMsg.style.color = 'red';
          pwdMsg.textContent = '‚ùå M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!';
          return;
        }
        if (newPassword.length < 6) {
          pwdMsg.style.color = 'red';
          pwdMsg.textContent = '‚ùå M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±.';
          return;
        }

        changePwdBtn.disabled = true;
        changePwdBtn.textContent = 'ƒêang x·ª≠ l√Ω...';

        try {
          const res = await fetch('/auth/change-password', {
            method: 'PUT',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ currentPassword, newPassword })
          });
          const data = await res.json();
          if (res.ok) {
            pwdMsg.style.color = 'green';
            pwdMsg.textContent = '‚úÖ ' + (data.message || 'ƒê√£ c·∫≠p nh·∫≠t m·∫≠t kh·∫©u.');
            document.getElementById('current-password').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
          } else {
            pwdMsg.style.color = 'red';
            pwdMsg.textContent = '‚ùå ' + (data.error || 'C√≥ l·ªói');
          }
        } catch (err) {
          pwdMsg.style.color = 'red';
          pwdMsg.textContent = '‚ùå L·ªói k·∫øt n·ªëi server.';
        } finally {
          changePwdBtn.disabled = false;
          changePwdBtn.textContent = 'C·∫≠p nh·∫≠t m·∫≠t kh·∫©u';
        }
      });
    }

    // Ch·∫°y khi load trang
    loadProfile();
  </script>
</body>
</html>
